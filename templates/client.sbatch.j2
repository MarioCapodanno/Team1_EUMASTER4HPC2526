#!/bin/bash -l

#SBATCH --time={{ slurm.time_limit }}
#SBATCH --qos={{ slurm.qos }}
#SBATCH --partition={{ slurm.partition }}
#SBATCH --account={{ slurm.account }}
#SBATCH --nodes={{ slurm.num_nodes }}
#SBATCH --ntasks={{ slurm.num_tasks }}
#SBATCH --ntasks-per-node={{ slurm.tasks_per_node }}

echo "Starting load test client {{ client_id }}..."
echo "Date: $(date)"
echo "Hostname: $(hostname -s)"
echo "Target service node: {{ service_node }}"
echo "Service port: {{ service_port }}"

# Load environment if needed
{% if load_modules %}
{% for module in load_modules %}
module add {{ module }}
{% endfor %}
{% endif %}

# Simple load test - connect to service node
for j in {1..{{ num_requests }}}; do
    echo "Client {{ client_id }} sending request $j to {{ service_node }}:{{ service_port }}..."
    echo "Request details:"
    echo "  - Model: {{ model }}"
    echo "  - Prompt: {{ prompt_prefix }} client {{ client_id }}, request $j"
    echo "  - Timeout: {{ request_timeout }} seconds"
    
    # Capture timing metrics
    start_time=$(date +%s.%N)
    echo "START_TIME:$start_time"
    
    # Retry logic for model not found (404) errors
    retry_count=0
    max_retries=3
    while [ $retry_count -lt $max_retries ]; do
        response=$(curl -X POST http://{{ service_node }}:{{ service_port }}/api/generate \
            -H "Content-Type: application/json" \
            -d '{"model": "{{ model }}", "prompt": "{{ prompt_prefix }} client {{ client_id }}, request $j"}' \
            --max-time {{ request_timeout }} \
            --verbose \
            --show-error \
            --write-out "HTTP Status: %{http_code}, Time: %{time_total}s\n" 2>&1)
        
        echo "$response"
        
        # Check if response contains 404 error
        if echo "$response" | grep -q "HTTP Status: 404"; then
            retry_count=$((retry_count + 1))
            echo "Model not found, retry $retry_count/$max_retries in 10 seconds..."
            sleep 10
        else
            # Success or different error, break retry loop
            break
        fi
    done
    
    if [ $retry_count -eq $max_retries ]; then
        echo "Max retries reached for request $j"
    fi
    
    end_time=$(date +%s.%N)
    duration=$(echo "$end_time - $start_time" | bc -l)
    echo "END_TIME:$end_time"
    echo "DURATION:$duration"
    echo "Request $j completed in ${duration}s"
    sleep {{ request_interval }}
done

echo "Client {{ client_id }} finished load test"
